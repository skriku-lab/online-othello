<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>安全オンラインオセロ</title>
<style>
body { font-family:sans-serif; display:flex; flex-direction:column; align-items:center; margin-top:20px; }
#board { display:grid; grid-template-columns:repeat(8,50px); grid-template-rows:repeat(8,50px); gap:2px; margin-bottom:10px;}
.cell { width:50px; height:50px; background-color:green; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:5px; }
.stone { width:40px; height:40px; border-radius:50%; }
.black { background:black; }
.white { background:white; }
</style>
</head>
<body>

<h1>安全オンラインオセロ</h1>
<div id="roomDiv">
部屋番号: <input id="roomInput" maxlength="4">
<button onclick="joinRoom()">入室</button>
</div>
<div id="info"></div>
<div id="board"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCsh7nseXVBgYa8C8o2c-dvkLnwkb8F7wE",
  authDomain: "on-line-reversi-1-skriku.firebaseapp.com",
  databaseURL: "https://on-line-reversi-1-skriku-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "on-line-reversi-1-skriku",
  storageBucket: "on-line-reversi-1-skriku.firebasestorage.app",
  messagingSenderId: "34367295976",
  appId: "1:34367295976:web:703a1f70e4e01adf9b545d"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let uid = null;
let myColor = null;
let roomNumber = null;
let board = [];

auth.signInAnonymously().then(u => uid = u.user.uid);

const SIZE = 8;
const boardDiv = document.getElementById("board");
const infoDiv = document.getElementById("info");

function initialBoard(){
  const b = Array(SIZE).fill().map(()=>Array(SIZE).fill(0));
  b[3][3]=2; b[3][4]=1; b[4][3]=1; b[4][4]=2;
  return b;
}

function renderBoard(){
  boardDiv.innerHTML="";
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.onclick=()=>handleClick(r,c);
      if(board[r][c]){
        const s=document.createElement("div");
        s.className="stone "+(board[r][c]===1?"black":"white");
        cell.appendChild(s);
      }
      boardDiv.appendChild(cell);
    }
  }
}

function handleClick(r,c){
  if(!myColor) return;
  const myNum = myColor==="black"?1:2;

  db.ref("rooms/"+roomNumber).transaction(room=>{
    if(!room) return;
    if(room.currentTurn!==myColor) return;
    if(room.board[r][c]!==0) return;

    const flipped = getFlipped(room.board,r,c,myNum);
    if(flipped.length===0) return;

    room.board[r][c]=myNum;
    flipped.forEach(([x,y])=>room.board[x][y]=myNum);
    room.currentTurn = myColor==="black"?"white":"black";
    return room;
  });
}

function getFlipped(b,r,c,p){
  const o=p===1?2:1;
  const d=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];
  let res=[];
  for(const [dr,dc] of d){
    let x=r+dr,y=c+dc,tmp=[];
    while(x>=0&&x<8&&y>=0&&y<8){
      if(b[x][y]===o) tmp.push([x,y]);
      else if(b[x][y]===p){ res=res.concat(tmp); break; }
      else break;
      x+=dr;y+=dc;
    }
  }
  return res;
}

function joinRoom(){
  roomNumber=document.getElementById("roomInput").value;
  const ref=db.ref("rooms/"+roomNumber);

  ref.once("value").then(s=>{
    if(!s.exists()){
      ref.set({
        board: initialBoard(),
        players:{black:uid,white:null},
        currentTurn:"black"
      });
      myColor="black";
    } else {
      const p=s.val().players;
      if(!p.white){
        ref.child("players/white").set(uid);
        myColor="white";
      } else {
        alert("満員");
      }
    }
    listenRoom();
  });
}

function listenRoom(){
  db.ref("rooms/"+roomNumber).on("value",s=>{
    const d=s.val();
    if(!d) return;

    board = d.board;
    renderBoard();

    // 相手がまだいない場合
    if(!d.players.white){
      infoDiv.textContent = "相手の参加を待っています…";
      return;
    }

    // 通常のターン表示
    infoDiv.textContent =
      d.currentTurn === myColor
        ? "あなたのターン"
        : "相手のターン";
  });
}

</script>
</body>
</html>
