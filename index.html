<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>安全オンラインオセロ</title>
<style>
body { font-family:sans-serif; display:flex; flex-direction:column; align-items:center; margin-top:20px; }
#board { display:grid; grid-template-columns:repeat(8,50px); grid-template-rows:repeat(8,50px); gap:2px; margin-bottom:10px;}
.cell { width:50px; height:50px; background-color:green; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:5px; }
.stone { width:40px; height:40px; border-radius:50%; }
.black { background:black; }
.white { background:white; }
button { margin:4px; }
</style>
</head>
<body>

<h1>安全オンラインオセロ</h1>

<div>
  <button onclick="startAIGame()">AIと対戦</button>
  <button onclick="leaveOnline()">オンラインをやめる</button>
</div>

<div id="roomDiv">
  部屋番号: <input id="roomInput" maxlength="4">
  <button onclick="joinRoom()">オンライン対戦</button>
</div>

<div id="info"></div>
<div id="board"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* =====================
   Firebase
===================== */
const firebaseConfig = {
  apiKey: "AIzaSyCsh7nseXVBgYa8C8o2c-dvkLnwkb8F7wE",
  authDomain: "on-line-reversi-1-skriku.firebaseapp.com",
  databaseURL: "https://on-line-reversi-1-skriku-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "on-line-reversi-1-skriku",
  storageBucket: "on-line-reversi-1-skriku.firebasestorage.app",
  messagingSenderId: "34367295976",
  appId: "1:34367295976:web:703a1f70e4e01adf9b545d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
firebase.auth().signInAnonymously();

/* =====================
   共通変数
===================== */
const SIZE = 8;
let board = [];
let mode = null;           // "ai" | "online"
let myColor = null;        // "black" | "white"
let currentTurn = "black";
let roomNumber = null;

const boardDiv = document.getElementById("board");
const infoDiv = document.getElementById("info");

/* =====================
   初期盤面
===================== */
function initialBoard(){
  const b = Array(SIZE).fill().map(()=>Array(SIZE).fill(0));
  b[3][3]=2; b[3][4]=1;
  b[4][3]=1; b[4][4]=2;
  return b;
}

/* =====================
   描画
===================== */
function renderBoard(){
  boardDiv.innerHTML="";
  for(let r=0;r<SIZE;r++){
    for(let c=0;c<SIZE;c++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.onclick=()=>handleClick(r,c);
      if(board[r][c]){
        const s=document.createElement("div");
        s.className="stone "+(board[r][c]===1?"black":"white");
        cell.appendChild(s);
      }
      boardDiv.appendChild(cell);
    }
  }
}

/* =====================
   クリック処理
===================== */
function handleClick(r,c){
  if(mode==="ai") handleAIMove(r,c);
  if(mode==="online") handleOnlineMove(r,c);
}

/* =====================
   裏返し判定
===================== */
function getFlipped(b,r,c,p){
  if(b[r][c]!==0) return [];
  const o=p===1?2:1;
  const d=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];
  let res=[];
  for(const [dr,dc] of d){
    let x=r+dr,y=c+dc,tmp=[];
    while(x>=0&&x<8&&y>=0&&y<8){
      if(b[x][y]===o) tmp.push([x,y]);
      else if(b[x][y]===p){ res=res.concat(tmp); break; }
      else break;
      x+=dr;y+=dc;
    }
  }
  return res;
}

/* =====================
   AIモード
===================== */
function startAIGame(){
  mode="ai";
  myColor="black";
  currentTurn="black";
  board = initialBoard();
  infoDiv.textContent="あなたのターン（AI）";
  renderBoard();
}

function handleAIMove(r,c){
  if(currentTurn!=="black") return;
  const flip=getFlipped(board,r,c,1);
  if(!flip.length) return;

  board[r][c]=1;
  flip.forEach(([x,y])=>board[x][y]=1);
  currentTurn="white";
  renderBoard();

  setTimeout(aiMove,500);
}

function aiMove(){
  if(checkGameEnd()) return;

  let moves=[];
  for(let r=0;r<8;r++)for(let c=0;c<8;c++){
    if(getFlipped(board,r,c,2).length) moves.push([r,c]);
  }

  // AIがパス
  if(!moves.length){
    infoDiv.textContent="AIはパス。あなたのターン";
    currentTurn="black";
    return;
  }

  const [r,c]=moves[Math.floor(Math.random()*moves.length)];
  const flip=getFlipped(board,r,c,2);
  board[r][c]=2;
  flip.forEach(([x,y])=>board[x][y]=2);

  currentTurn="black";
  renderBoard();

  // 人間が置けない場合もパス
  if(!hasValidMove(board,1)){
    infoDiv.textContent="あなたはパス。AIのターン";
    currentTurn="white";
    setTimeout(aiMove,500);
    return;
  }

  infoDiv.textContent="あなたのターン（AI）";
}


/* =====================
   オンライン
===================== */
function joinRoom(){
  mode="online";
  roomNumber=document.getElementById("roomInput").value;
  const ref=db.ref("rooms/"+roomNumber);

  ref.once("value").then(s=>{
    if(!s.exists()){
      ref.set({
        board: initialBoard(),
        players:{black:"host",white:null},
        currentTurn:"black"
      });
      myColor="black";
    }else{
      myColor="white";
      ref.child("players/white").set("guest");
    }
    listenRoom();
  });
}

function handleOnlineMove(r,c){
  if(currentTurn!==myColor) return;
  const p=myColor==="black"?1:2;
  const flip=getFlipped(board,r,c,p);
  if(!flip.length) return;

  const ref=db.ref("rooms/"+roomNumber);
  board[r][c]=p;
  flip.forEach(([x,y])=>board[x][y]=p);
  ref.update({
    board,
    currentTurn: myColor==="black"?"white":"black"
  });
}

function listenRoom(){
  db.ref("rooms/"+roomNumber).on("value",s=>{
    const d=s.val();
    if(!d) return;

    board=d.board;
    currentTurn=d.currentTurn;
    renderBoard();

    if(checkGameEnd()) return;

    infoDiv.textContent =
      currentTurn===myColor ? "あなたのターン" : "相手のターン";
  });
}

function leaveOnline(){
  mode=null;
  infoDiv.textContent="モードを選択してください";
}

/* =====================
   共通：補助関数（追加）
===================== */

// 指定プレイヤーが置けるか
function hasValidMove(b, playerNum){
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      if(getFlipped(b,r,c,playerNum).length) return true;
    }
  }
  return false;
}

// 石数カウント
function countStones(){
  let black=0, white=0;
  for(let r=0;r<8;r++){
    for(let c=0;c<8;c++){
      if(board[r][c]===1) black++;
      if(board[r][c]===2) white++;
    }
  }
  return {black, white};
}

// 勝敗判定
function checkGameEnd(){
  const blackCan = hasValidMove(board,1);
  const whiteCan = hasValidMove(board,2);

  if(blackCan || whiteCan) return false;

  const {black, white} = countStones();
  let result = `黒:${black} 白:${white}  → `;

  if(black>white) result += "黒の勝ち！";
  else if(white>black) result += "白の勝ち！";
  else result += "引き分け！";

  infoDiv.textContent = result;
  return true;
}

</script>
</body>
</html>
